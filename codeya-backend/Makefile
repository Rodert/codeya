.PHONY: build run test clean migrate deps fmt lint
.PHONY: docker-build docker-up docker-down docker-restart docker-logs
.PHONY: docker-db docker-db-stop docker-db-restart docker-clean

# ==================== æœ¬åœ°å¼€å‘ ====================

# æ„å»ºé¡¹ç›®
build:
	go build -o bin/server cmd/server/main.go

# è¿è¡Œé¡¹ç›®
run:
	go run cmd/server/main.go

# è¿è¡Œæµ‹è¯•
test:
	go test -v ./...

# æ¸…ç†æ„å»ºæ–‡ä»¶
clean:
	rm -rf bin/
	rm -rf logs/

# æ•°æ®åº“è¿ç§»ï¼ˆéœ€è¦æ‰‹åŠ¨æ‰§è¡Œ SQL è„šæœ¬ï¼‰
migrate:
	@echo "è¯·æ‰‹åŠ¨æ‰§è¡Œ SQL è„šæœ¬ï¼š"
	@echo "mysql -h localhost -u codeya_user -p codeya < scripts/migration/001_init_schema.sql"
	@echo "mysql -h localhost -u codeya_user -p codeya < scripts/migration/002_init_data.sql"

# å®‰è£…ä¾èµ–
deps:
	go mod download
	go mod tidy

# æ ¼å¼åŒ–ä»£ç 
fmt:
	go fmt ./...

# ä»£ç æ£€æŸ¥
lint:
	golangci-lint run ./...

# ==================== Docker ç›¸å…³ ====================

# æ„å»º Docker é•œåƒï¼ˆä½¿ç”¨é»˜è®¤é•œåƒæºï¼‰
docker-build:
	docker-compose build

# ä½¿ç”¨é˜¿é‡Œäº‘é•œåƒæ„å»ºï¼ˆå‚è€ƒ mini-study é…ç½®ï¼‰
docker-build-aliyun:
	docker-compose build \
	  --build-arg BASE_IMAGE=crpi-4otucz63tm2q5dhq.cn-beijing.personal.cr.aliyuncs.com/library-shiyu/golang:1.21-alpine \
	  backend
	@echo "âœ“ ä½¿ç”¨é˜¿é‡Œäº‘é•œåƒæ„å»ºå®Œæˆ"

# ä½¿ç”¨è‡ªå®šä¹‰é•œåƒæ„å»º
docker-build-custom:
	@read -p "è¯·è¾“å…¥è‡ªå®šä¹‰é•œåƒåœ°å€: " image; \
	docker-compose build --build-arg BASE_IMAGE=$$image backend
	@echo "âœ“ ä½¿ç”¨è‡ªå®šä¹‰é•œåƒæ„å»ºå®Œæˆ"

# å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆMySQL + Redis + Backendï¼‰
docker-up:
	docker-compose up -d
	@echo "âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨"
	@echo "Backend API: http://localhost:8080"
	@echo "æŸ¥çœ‹æ—¥å¿—: make docker-logs"

# åœæ­¢æ‰€æœ‰æœåŠ¡
docker-down:
	docker-compose down
	@echo "âœ“ æ‰€æœ‰æœåŠ¡å·²åœæ­¢"

# é‡å¯æ‰€æœ‰æœåŠ¡
docker-restart:
	docker-compose restart
	@echo "âœ“ æ‰€æœ‰æœåŠ¡å·²é‡å¯"

# æŸ¥çœ‹æ—¥å¿—
docker-logs:
	docker-compose logs -f

# ä»…å¯åŠ¨æ•°æ®åº“ï¼ˆMySQL + Redisï¼‰
docker-db:
	docker-compose up -d mysql redis
	@echo "âœ“ æ•°æ®åº“æœåŠ¡å·²å¯åŠ¨"
	@echo "MySQL: localhost:3306 (ç”¨æˆ·: codeya_user, å¯†ç : codeya_pass_2024)"
	@echo "Redis: localhost:6379 (å¯†ç : codeya_redis_2024)"

# åœæ­¢æ•°æ®åº“æœåŠ¡
docker-db-stop:
	docker-compose stop mysql redis
	@echo "âœ“ æ•°æ®åº“æœåŠ¡å·²åœæ­¢"

# é‡å¯æ•°æ®åº“æœåŠ¡
docker-db-restart:
	docker-compose restart mysql redis
	@echo "âœ“ æ•°æ®åº“æœåŠ¡å·²é‡å¯"

# æ¸…ç†æ‰€æœ‰ Docker å®¹å™¨å’Œæ•°æ®
docker-clean:
	@echo "è­¦å‘Š: è¿™å°†åˆ é™¤æ‰€æœ‰å®¹å™¨å’Œæ•°æ®ï¼"
	@read -p "ç¡®å®šè¦ç»§ç»­å—ï¼Ÿ(yes/no): " confirm; \
	if [ "$$confirm" = "yes" ]; then \
		docker-compose down -v; \
		echo "âœ“ æ‰€æœ‰å®¹å™¨å’Œæ•°æ®å·²åˆ é™¤"; \
	else \
		echo "æ“ä½œå·²å–æ¶ˆ"; \
	fi

# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
docker-ps:
	docker-compose ps

# è¿›å…¥åç«¯å®¹å™¨
docker-exec-backend:
	docker-compose exec backend sh

# è¿›å…¥ MySQL å®¹å™¨
docker-exec-mysql:
	docker-compose exec mysql mysql -u codeya_user -p codeya

# è¿›å…¥ Redis å®¹å™¨
docker-exec-redis:
	docker-compose exec redis redis-cli -a codeya_redis_2024

# ==================== å¸®åŠ© ====================

help:
	@echo "CodeYa Backend Makefile å‘½ä»¤"
	@echo ""
	@echo "æœ¬åœ°å¼€å‘:"
	@echo "  make build          - æ„å»ºé¡¹ç›®"
	@echo "  make run            - è¿è¡Œé¡¹ç›®"
	@echo "  make test           - è¿è¡Œæµ‹è¯•"
	@echo "  make clean          - æ¸…ç†æ„å»ºæ–‡ä»¶"
	@echo "  make deps           - å®‰è£…ä¾èµ–"
	@echo "  make fmt            - æ ¼å¼åŒ–ä»£ç "
	@echo "  make lint           - ä»£ç æ£€æŸ¥"
	@echo "  make migrate        - æ•°æ®åº“è¿ç§»"
	@echo ""
	@echo "Docker - é•œåƒæ„å»º:"
	@echo "  make docker-build   - æ„å»º Docker é•œåƒï¼ˆé»˜è®¤é•œåƒæºï¼‰"
	@echo "  make docker-build-aliyun - ä½¿ç”¨é˜¿é‡Œäº‘é•œåƒæ„å»ºï¼ˆæ¨èå›½å†…ç”¨æˆ·ï¼‰"
	@echo "  make docker-build-custom - ä½¿ç”¨è‡ªå®šä¹‰é•œåƒæ„å»º"
	@echo ""
	@echo "Docker - å®Œæ•´æœåŠ¡:"
	@echo "  make docker-up      - å¯åŠ¨æ‰€æœ‰æœåŠ¡"
	@echo "  make docker-down    - åœæ­¢æ‰€æœ‰æœåŠ¡"
	@echo "  make docker-restart - é‡å¯æ‰€æœ‰æœåŠ¡"
	@echo "  make docker-logs    - æŸ¥çœ‹æ—¥å¿—"
	@echo "  make docker-ps      - æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
	@echo ""
	@echo "Docker - ä»…æ•°æ®åº“:"
	@echo "  make docker-db      - å¯åŠ¨æ•°æ®åº“æœåŠ¡ï¼ˆMySQL + Redisï¼‰"
	@echo "  make docker-db-stop - åœæ­¢æ•°æ®åº“æœåŠ¡"
	@echo "  make docker-db-restart - é‡å¯æ•°æ®åº“æœåŠ¡"
	@echo ""
	@echo "Docker - å·¥å…·:"
	@echo "  make docker-clean   - æ¸…ç†æ‰€æœ‰å®¹å™¨å’Œæ•°æ®"
	@echo "  make docker-exec-backend - è¿›å…¥åç«¯å®¹å™¨"
	@echo "  make docker-exec-mysql   - è¿›å…¥ MySQL å®¹å™¨"
	@echo "  make docker-exec-redis   - è¿›å…¥ Redis å®¹å™¨"
	@echo ""
	@echo "ğŸ“š æ›´å¤šä¿¡æ¯: æŸ¥çœ‹ DOCKER_CUSTOM_IMAGE.md äº†è§£è‡ªå®šä¹‰é•œåƒé…ç½®"


